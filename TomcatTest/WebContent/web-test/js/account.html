<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
            <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">
                <title>
                    业主管理界面-人脸识别智能门禁系统
                </title>
                <link href="layui/css/layui.css" media="all" rel="stylesheet" type="text/css">
                    <script src="jquery-3.3.1.js" type="text/javascript">
                    </script>
                    <script src="layui/layui.js" type="text/javascript">
                    </script>
                    <script src="jquery-form.js" type="text/javascript">
                    </script>
                </link>
            </meta>
        </meta>
    </head>
    <body class="layui-layout-body">
        <div class="layui-layout layui-layout-admin">
            <div class="layui-header">
                <div class="layui-logo">
                    业主管理
                </div>
                <!-- 头部区域（可配合layui已有的水平导航） -->
                <ul class="layui-nav layui-layout-right">
                    <li class="layui-nav-item">
                        <a href="javascript:;">
                            <img class="layui-nav-img" src="../images/default.jpg" id="status">
                                <span id="username">用户</span>
                            </img>
                        </a>
                        <dl class="layui-nav-child">
                            <dd>
                                <a href="">
                                    基本资料
                                </a>
                            </dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item">
                        <a href="login.html">
                            退出
                        </a>
                    </li>
                </ul>
            </div>
            <div class="layui-side layui-bg-black">
                <div class="layui-side-scroll">
                    <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
                    <ul class="layui-nav layui-nav-tree" lay-filter="test">
                        <li class="layui-nav-item">
                            <a href="">
                                可通行人员列表
                            </a>
                        </li>
                        <li class="layui-nav-item">
                            <a href="">
                                个人资料
                            </a>
                        </li>
                        <li class="layui-nav-item">
                            <a href="">
                                使用帮助
                            </a>
                        </li>
                        <li class="layui-nav-item">
                            <a href="">
                                问题申报
                            </a>
                        </li>
                        <li class="layui-nav-item">
                            <a href="">
                                关于
                            </a>
                        </li>
                        <li class="layui-nav-item">
                            <a href="javascript:;">
                                其它系统
                            </a>
                            <dl class="layui-nav-child">
                                <dd>
                                    <a href="">
                                        消息管理
                                    </a>
                                </dd>
                                <dd>
                                    <a href="">
                                        授权管理
                                    </a>
                                </dd>
                            </dl>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="layui-body">
                <!-- 内容主体区域 -->
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px; line-height: 80px">
                    <legend>
                        账户信息修改
                    </legend>
                    <form "multipart="" action="http://192.168.0.122:8080/api/userUpdate/12344" class="layui-form" contenttype:="" form-data"="" id="info" lay-filter="info" method="post">
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                姓名
                            </label>
                            <div class="layui-input-inline">
                                <input autocomplete="on" class="layui-input" lay-verify="required|name" name="username" placeholder="必填" type="text">
                                </input>
                            </div>
                            <div class="layui-form-mid layui-word-aux">
                                请填写本人真实姓名
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">
                                    手机
                                </label>
                                <div class="layui-input-inline">
                                    <input autocomplete="on" class="layui-input" lay-verify="required|phone" name="tel" placeholder="必填" type="tel">
                                    </input>
                                </div>
                                <div class="layui-form-mid layui-word-aux">
                                    作为联系方式
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                登录密码
                            </label>
                            <div class="layui-input-inline">
                                <input autocomplete="off" class="layui-input" id="pwd1" lay-verify="required|pwd" name="password" placeholder="必填" type="password">
                                </input>
                            </div>
                            <div class="layui-form-mid layui-word-aux">
                                请填写6到12位密码
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">
                                确认密码
                            </label>
                            <div class="layui-input-inline">
                                <input autocomplete="off" class="layui-input" id="pwd2" lay-verify="required" placeholder="必填" type="password">
                                    <input name="id" type="hidden">
                                    </input>
                                </input>
                            </div>
                            <div class="layui-form-mid layui-word-aux">
                                再次输入密码以确认
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">
                                    上传人脸：
                                </label>
                                <div class="layui-upload">
                                    <blockquote class="layui-elem-quote layui-quote-nm layui-input-inline" style="float: left;position: relative;left:45%">
                                        <h4 id="tip">
                                            即将上传的照片预览：
                                        </h4>
                                        <div class="layui-upload-list">
                                            <img class="layui-upload-img layui-input-inline" height="200" id="pre-photo" src="../images/default.jpg" width="200">
                                                <input accept="image/jpeg,image/jpg" autocomplete="off" name="image" type="file"/>
                                                <input name="methodId" type="hidden" value="1">
                                                    <input name="endDate" type="hidden" value="9999-12-30 00:00:00">
                                                    </input>
                                                </input>
                                            </img>
                                        </div>
                                        <b>
                                            请上传 文件大小 小于100KB 的 单人清晰 人脸照片!
                                        </b>
                                    </blockquote>
                                </div>
                            </div>
                            s
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                                <button class="layui-btn layui-btn-disabled" disabled="true" id="sub" lay-filter="sub" lay-submit="">
                                    立即提交
                                </button>
                                <button class="layui-btn layui-btn-primary" type="reset">
                                    重置
                                </button>
                            </div>
                        </div>
                    </form>
                </fieldset>
            </div>
            <div class="layui-footer">
                <!-- 底部固定区域 -->
                版权所有 © coldcode 浙ICP备666号 地址：浙江·杭州市留和路318号浙江科技学院习德楼C1-509 邮编：310023
            </div>
        </div>
        <script type="text/javascript">
            var searchStr = location.search;
            //由于searchStr属性值包括“?”，所以除去该字符
            searchStr = searchStr.substr(1);
            //将searchStr字符串分割成数组，数组中的每一个元素为一个参数和参数值
            var searchs = searchStr.split("&");
            //获得第一个参数和值
            var address = searchs[0].split("=");
            //获取到登陆用户的id
            var id = address[1];

            $("[name='id']").val(id);

            var imgurl = "http://192.168.0.122:8080/images/" + id + ".jpg";
            
            var infourl = "http://192.168.0.122:8080/api/user/" + id;

            $.ajax({
                type: 'get',
                url: imgurl,
                cache: false,
                // dataType: "jsonp", //跨域采用jsonp方式 
                processData: false,
                timeout:10000, //超时时间，毫秒
                success: function (XHR, TS) {
                    $("#pre-photo").attr("src",imgurl);
                    $("#status").attr("src",imgurl);
                    $("#tip").text("已上传的照片：");
                    $("#sub").attr("class","layui-btn layui-btn-normal");
                    $("#sub").attr("disabled",false);
                }     
            });

            $.ajax({
                type: 'get',
                url: infourl,
                cache: false,
                // dataType: "jsonp", //跨域采用jsonp方式 
                processData: false,
                timeout:10000, //超时时间，毫秒
                success: function (XHR, TS) {
                    if(XHR["id"] != null){
                        $("[name='username']").val(XHR["username"]);
                        $("[name='tel']").val(XHR["tel"]);
                        $("[name='password']").val(XHR["password"]);
                        $("#username").text(XHR["username"]);
                    }else{

                        layer.alert('欢迎您第一次登录本系统，请完善个人信息', {icon: 6}); 
                    }
                }     
            });


            $("[name='image']").change(function(){  
                var files = this.files; // 获得文件对象
                var maxsize = 1024*100;     
                for (var i = 0, f; f = files[i]; i++){  //检查文件大小   
                    // console.log(f.size);
                    if(f.size > maxsize){   
                        alert("上传的图片不能超过100KB!");   
                        $(this).val('');   
                    }   
                }
                var url = window.URL.createObjectURL(this.files.item(0));
                $(this).siblings().filter("#pre-photo").attr("src",url);
                $("#sub").attr("class","layui-btn layui-btn-normal");
                $("#sub").attr("disabled",false);
                $("#tip").text("即将上传的照片预览：");
            });

            layui.use(['form', 'layedit','layer','element'], function(){
                var form = layui.form
                ,layer = layui.layer;


                //自定义验证规则
                form.verify({
                    name: function(value){
                       if(value.length < 2){
                           return '名字至少得2个字符';
                       }
                    }
                    ,pwd: function(value){
                        if($('#pwd1').val() != $('#pwd2').val()){
                            $('#pwd1').val("");
                            $('#pwd2').val("");
                            return '两次填写的密码不一致！';
                        }else if(value.length < 6 || value.length > 12){
                            return '密码必须6到12位';
                        }

                    }
                });
                //监听提交
                form.on('submit(sub)', function(data){

                var searchStr = location.search;
                //由于searchStr属性值包括“?”，所以除去该字符
                searchStr = searchStr.substr(1);
                //将searchStr字符串分割成数组，数组中的每一个元素为一个参数和参数值
                var searchs = searchStr.split("&");
                //获得第一个参数和值
                var address = searchs[0].split("=");
                //获取到登陆用户的id
                var id = address[1];


                var waiting = layer.open({
                    type: 3
                });

                var option = {
                    url : 'http://192.168.0.122:8080/api/userUpdate/' + id,
                    type : 'POST',
                    dataType : 'json',
                    success : function(data) {
                        layer.close(waiting);
                        alert(JSON.stringify(data) + "--上传成功,确认后返回主界面");
                        window.location.href='peopletable.html?id='+id;
                    },
                    error: function(data) {
                        layer.close(waiting);
                        alert(JSON.stringify(data) + "--上传失败,请重试");
                    }
                 };
                $("#info").ajaxSubmit(option);
                return false;
                });
            });
        </script>
    </body>
</html>